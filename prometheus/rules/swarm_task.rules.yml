groups:
- name: swarm_task_alerts
  rules:
  # Container CPU Alerts
  - alert: ContainerHighCPU
    expr: sum(rate(container_cpu_usage_seconds_total{container_label_com_docker_swarm_task_name=~".+"}[1m])) BY (container_label_com_docker_swarm_task_name, container_label_com_docker_swarm_node_id) * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} on ''{{ $labels.container_label_com_docker_swarm_node_id }}'' CPU usage is at {{ humanize $value}}%.'
      summary: High CPU for task '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Container Memory Near Limit
  - alert: ContainerMemoryNearLimit
    expr: (container_memory_working_set_bytes{container_label_com_docker_swarm_task_name=~".+"} / container_spec_memory_limit_bytes{container_label_com_docker_swarm_task_name=~".+"}) * 100 > 90
    for: 5m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} memory usage is at {{ humanize $value}}% of its limit.'
      summary: Container near memory limit '{{ $labels.container_label_com_docker_swarm_task_name }}'

  - alert: ContainerMemoryCritical
    expr: (container_memory_working_set_bytes{container_label_com_docker_swarm_task_name=~".+"} / container_spec_memory_limit_bytes{container_label_com_docker_swarm_task_name=~".+"}) * 100 > 95
    for: 2m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} memory usage is critically high at {{ humanize $value}}% of its limit.'
      summary: Container memory critical '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Container Memory High (absolute)
  - alert: ContainerHighMemory
    expr: sum(container_memory_working_set_bytes{container_label_com_docker_swarm_task_name=~".+"}) BY (container_label_com_docker_swarm_task_name, container_label_com_docker_swarm_node_id) > 2e+09
    for: 10m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} is using {{ humanize $value}} of memory.'
      summary: High memory usage for task '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # CPU Throttling
  - alert: ContainerCPUThrottling
    expr: rate(container_cpu_cfs_throttled_periods_total{container_label_com_docker_swarm_task_name=~".+"}[5m]) / rate(container_cpu_cfs_periods_total{container_label_com_docker_swarm_task_name=~".+"}[5m]) * 100 > 25
    for: 5m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} is being CPU throttled {{ humanize $value}}% of the time.'
      summary: CPU throttling for task '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Container Restart Loop
  - alert: ContainerRestartLoop
    expr: increase(container_start_time_seconds{container_label_com_docker_swarm_task_name=~".+"}[15m]) > 3
    for: 5m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} has restarted {{ $value }} times in 15 minutes.'
      summary: Container restart loop '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Container Not Running
  - alert: ContainerNotRunning
    expr: sum(container_tasks_state{state!="running"}) by (container_label_com_docker_stack_namespace) > 0
    for: 3m
    labels:
      severity: warning
    annotations:
      description: Container not in running state in stack '{{ $labels.container_label_com_docker_stack_namespace }}'
      summary: Container not running in stack '{{ $labels.container_label_com_docker_stack_namespace }}'

  # OOM Kill Detection (using container restart with memory issues)
  - alert: ContainerOOMRisk
    expr: (container_memory_working_set_bytes{container_label_com_docker_swarm_task_name=~".+"} / container_spec_memory_limit_bytes{container_label_com_docker_swarm_task_name=~".+"}) > 0.98
    for: 1m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} is at 98%+ of memory limit and at risk of OOM kill.'
      summary: OOM risk for '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Service Health - Stack specific alerts
  - alert: HaystackMongoContainersMissing
    expr: count(container_last_seen{container_label_com_docker_stack_namespace="haystack-mongo"}) < 3
    for: 5m
    labels:
      severity: critical
    annotations:
      description: 'Haystack-mongo stack has less than 3 containers running (found {{ $value }}).'
      summary: Haystack-mongo containers missing

  - alert: MySQLContainersMissing
    expr: count(container_last_seen{container_label_com_docker_stack_namespace="mysql"}) < 2
    for: 5m
    labels:
      severity: critical
    annotations:
      description: 'MySQL stack has less than 2 containers running (found {{ $value }}).'
      summary: MySQL containers missing

  # Generic Service Down Alert
  - alert: ServiceNoRunningContainers
    expr: count(container_last_seen{container_label_com_docker_swarm_service_name=~".+"}) by (container_label_com_docker_swarm_service_name) == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      description: 'Service {{ $labels.container_label_com_docker_swarm_service_name }} has no running containers.'
      summary: Service down - {{ $labels.container_label_com_docker_swarm_service_name }}

  # Container Network Errors
  - alert: ContainerNetworkErrors
    expr: increase(container_network_receive_errors_total{container_label_com_docker_swarm_task_name=~".+"}[5m]) > 10
    for: 5m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} has network receive errors.'
      summary: Network errors for '{{ $labels.container_label_com_docker_swarm_task_name }}'

  # Container Filesystem Usage
  - alert: ContainerFilesystemFull
    expr: (container_fs_usage_bytes{container_label_com_docker_swarm_task_name=~".+"} / container_fs_limit_bytes{container_label_com_docker_swarm_task_name=~".+"}) * 100 > 90
    for: 5m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.container_label_com_docker_swarm_task_name }} filesystem is {{ humanize $value}}% full.'
      summary: Container filesystem full '{{ $labels.container_label_com_docker_swarm_task_name }}'
